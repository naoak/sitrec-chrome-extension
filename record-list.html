<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="record-item.html">

<polymer-element name="record-list" attributes="server">
  <template>
    <style>
    :host {
      display: block;
    }
    :host ul {
      margin: 0;
      padding: 25px;
      list-style-type: none;
      box-sizing: border-box;
    }
    :host li {
      margin: 0;
      padding: 0;
    }
    </style>
    <core-ajax id="detailListAjax" url="{{server}}/api/record/detailList" handleAs="json"></core-ajax>
    <core-ajax id="downloadAjax" url="{{server}}/api/record/download" method="POST" contentType="application/json" handleAs="json"></core-ajax>
    <core-ajax id="deleteAjax" url="{{server}}/api/record/delete" method="POST" contentType="application/json" handleAs="json"></core-ajax>
    <core-toolbar>
      <core-icon-button icon="file-download" on-tap="{{downloadRecords}}"></core-icon-button>
      <core-icon-button icon="delete" on-tap="{{deleteRecords}}"></core-icon-button>
    </core-toolbar>
    <ul id="list" horizontal layout wrap>
    <template repeat='{{records}}'>
      <li>
        <record-item name="{{name}}" url="{{url}}" throttle="{{throttle}}" timing="{{timing}}" date="{{date}}" fullName="{{fullName}}"></record-item>
      </li>
    </template>
    </ul>
    <iframe id="downloadLayer" style="display: none;"></iframe>
  </template>
  <script>
  (function() {
    function trimProtocol(url) {
      var i = url.indexOf('://');
      if (i >= 0) {
        url = url.slice(i + 3);
      }
      return url;
    }
    Polymer({
      created: function() {
        this.records = [];
      },
      ready: function() {
        var self = this;
        this.$.detailListAjax.addEventListener('core-response', function(e) {
          var records = this.response.items;
          self.records = records.map(function(r) {
            r.url = trimProtocol(r.url);
            return r;
          });
        });
        this.$.downloadAjax.addEventListener('core-response', function(e) {
          self.$.downloadLayer.src = self.server + this.response.url;
        });
        this.$.deleteAjax.addEventListener('core-response', function(e) {
          self.loadDetailList();
        });
      },
      serverChanged: function() {
        this.loadDetailList();
      },
      loadDetailList: function() {
        this.$.detailListAjax.go();
      },
      downloadRecords: function() {
        var downloadAjax = this.$.downloadAjax;
        var downloadList = this.makeCheckedList();
        if (downloadList.length > 0) {
          downloadAjax.body = JSON.stringify({records: downloadList});
          downloadAjax.go();
        }
      },
      deleteRecords: function() {
        var deleteAjax = this.$.deleteAjax;
        var deleteList = this.makeCheckedList();
        if (deleteList.length > 0) {
          deleteAjax.body = JSON.stringify({records: deleteList});
          deleteAjax.go();
        }
      },
      makeCheckedList: function() {
        var items = Array.prototype.slice.call(this.$.list.querySelectorAll('record-item'));
        return items.filter(function(item) {
          return item.checked;
        }).map(function(item) {
          return item.fullName;
        });
      }
    });
  })();
  </script>
</polymer-element>
